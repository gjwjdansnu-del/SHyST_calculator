# 충격파 터널 계산 과정 상세 분석

## 입력 조건
- p₁ = 0.4212 bar = 42,120 Pa
- T₁ = 19°C = 292.15 K
- Vs = 707.01 m/s (충격파 속도)
- 가스: Air

## State 1: 초기 상태

### 계산:
```
ρ₁ = p₁ / (R × T₁)
   = 42120 / (287.056 × 292.15)
   = 0.5023 kg/m³

a₁ = √(γ × R × T₁)
   = √(1.4009 × 287.056 × 292.15)
   = 342.75 m/s

M_shock = Vs / a₁
        = 707.01 / 342.75
        = 2.063
```

**✅ State 1 결과:**
- p₁ = 42,120 Pa (0.4212 bar)
- T₁ = 292.15 K
- ρ₁ = 0.5023 kg/m³
- a₁ = 342.75 m/s
- M_shock = 2.063

---

## State 2: 입사 충격파 후

### 이론 (Rankine-Hugoniot 관계식):

충격파 좌표계에서:
- 충격파 앞 가스: 속도 V₁ = Vs (충격파에 대해)
- 충격파 뒤 가스: 속도 V₂ (충격파에 대해)

### 보존 법칙:

1. **질량 보존:**
   ```
   ρ₁ × V₁ = ρ₂ × V₂
   ```

2. **운동량 보존:**
   ```
   p₁ + ρ₁ × V₁² = p₂ + ρ₂ × V₂²
   ```

3. **에너지 보존:**
   ```
   h₁ + V₁²/2 = h₂ + V₂²/2
   ```

### 이상기체 초기 추정:

```
M₁ = Vs / a₁ = 2.063

ρ₂/ρ₁ = (γ+1) × M₁² / (2 + (γ-1) × M₁²)
       = (1.4+1) × 2.063² / (2 + (1.4-1) × 2.063²)
       = 2.4 × 4.256 / (2 + 0.4 × 4.256)
       = 10.214 / 3.702
       = 2.759

p₂/p₁ = (2γ × M₁² - (γ-1)) / (γ+1)
      = (2×1.4×4.256 - 0.4) / 2.4
      = (11.918 - 0.4) / 2.4
      = 11.518 / 2.4
      = 4.799

T₂ = p₂ / (ρ₂ × R)
```

### 초기 추정값:
```
ρ₂ = 0.5023 × 2.759 = 1.386 kg/m³
p₂ = 42120 × 4.799 = 202,098 Pa (2.02 bar)
T₂ = 202098 / (1.386 × 287.056) = 508 K
```

### Newton-Raphson 수렴:

반복적으로 (ρ₂, T₂)를 조정하여:
- 운동량 보존: `p₁ + ρ₁×V₁² = p₂ + ρ₂×V₂²`
- 에너지 보존: `h₁ + V₁²/2 = h₂ + V₂²/2`

두 식이 동시에 만족될 때까지 수렴.

### 실험실 좌표계 속도:
```
V₂ = V₁ × (ρ₁/ρ₂) = 707.01 × (0.5023/1.386) = 256 m/s (충격파 좌표계)
Vg = V₁ - V₂ = 707.01 - 256 = 451 m/s (실험실 좌표계)
```

**❓ 문제점:**
- 우리 계산: p₂ ≈ 2.0 bar, T₂ ≈ 507 K
- ESTCN (Vs=651): p₂ = 14.48 bar, T₂ = 866 K

**압력비가 너무 작습니다!**
- 우리: p₂/p₁ = 4.8
- ESTCN: p₂/p₁ = 34.4 (7배 차이!)

---

## State 5: 반사 충격파 후

### 이론:

State 2의 가스가 벽면에서 반사충격파를 만남:
- State 2 가스 속도: Vg = 451 m/s (실험실 좌표계)
- 반사충격파 속도: Vr (실험실 좌표계, 역방향)
- 충격파 좌표계에서 가스 접근 속도: Vr + Vg

### 경계 조건:
```
벽면에서 가스 속도 = 0 (no-slip)
따라서 State 5에서: V₅ = 0 (실험실 좌표계)
```

### Secant method로 Vr 찾기:

목표: `V₅ = Vr` (실험실 좌표계에서 정지)

반복:
1. State 2를 입력으로, 충격파 속도 (Vr + Vg)로 normal_shock 계산
2. 결과 V₅ 계산
3. `f = V₅ - Vr` 이 0이 되도록 Vr 조정

**❓ 문제점:**
- State 2가 잘못되면 State 5도 잘못됨
- 우리: p₅ ≈ 7 bar
- ESTCN: p₅ = 22 bar

---

## 핵심 문제 진단

### 가설 1: 충격파 속도 해석 오류

**ESTCN에서 Vs = 651 m/s를 사용했다면:**
```
M₁ = 651 / 342.75 = 1.899

p₂/p₁ = (2×1.4×1.899² - 0.4) / 2.4
      = (2×1.4×3.606 - 0.4) / 2.4
      = (10.097 - 0.4) / 2.4
      = 4.04

p₂ = 0.4212 × 4.04 = 1.70 bar
```

여전히 14.48 bar에 못 미침!

### 가설 2: 우리 코드의 보존 법칙 구현 오류

**확인 필요:**
1. 운동량 보존식에서 V₁, V₂가 올바른 좌표계인가?
2. 에너지 보존식에서 h + V²/2 계산이 맞는가?
3. Newton-Raphson 수렴이 제대로 되는가?

### 가설 3: ESTCN의 입력 조건이 다름

**가능성:**
- ESTCN이 실제로는 다른 p₁ 또는 T₁을 사용?
- Driver 압력 p₄가 영향을 주는가?

---

## 디버깅 제안

### 1. 이상기체 공식으로 역산:

ESTCN State 2: p₂ = 14.48 bar, T₂ = 866 K
```
p₂/p₁ = 14.48 / 0.4212 = 34.4

이상기체: p₂/p₁ = (2γM₁² - (γ-1)) / (γ+1)
34.4 = (2×1.4×M₁² - 0.4) / 2.4
82.56 = 2.8×M₁² - 0.4
82.96 = 2.8×M₁²
M₁² = 29.63
M₁ = 5.44

필요한 Vs = 5.44 × 342.75 = 1865 m/s !!!
```

**결론: ESTCN이 Vs = 1865 m/s 정도를 사용한 것처럼 보임!**

### 2. 코드 로직 확인:

`normal_shock` 함수에서:
```javascript
const V1 = Vs;  // ← 이게 맞나?
const momentum = state1.p + state1.rho * V1 * V1;
const h_total = state1.h + 0.5 * V1 * V1;
```

**의심:**
- `V1 = Vs`가 맞는가?
- 아니면 `V1 = Vs - u1` 이어야 하는가? (u1 = 0이므로 같음)

### 3. ESTCN 입력 재확인:

ESTCN 이미지에서:
- "Incident shock velocity" = 얼마?
- p₁, T₁ 값이 정확히 일치하는가?

---

## 다음 단계

1. **ESTCN 이미지에서 정확한 입력값 확인**
   - Incident shock velocity
   - p₁, T₁
   
2. **우리 코드의 normal_shock 함수 검증**
   - 간단한 이상기체 케이스로 테스트
   - M=2, γ=1.4 → p₂/p₁ = 4.5 나오는지 확인

3. **ESTCN 계산 재현**
   - ESTCN과 동일한 입력으로 우리 코드 실행
   - 어느 단계에서 차이가 나는지 확인
